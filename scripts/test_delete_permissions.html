<!DOCTYPE html>
<html>
<head>
    <title>Test Delete Permissions</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Prueba de Permisos de Eliminación</h1>
    <div id="status">Cargando...</div>
    <pre id="log"></pre>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBGJV81k0z4WHBHlYw0P0SQzYlHgpwWVDg",
            authDomain: "trazabilidad-ecoce.firebaseapp.com",
            projectId: "trazabilidad-ecoce",
            storageBucket: "trazabilidad-ecoce.appspot.com",
            messagingSenderId: "1098503063628",
            appId: "1:1098503063628:web:YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const log = (message) => {
            document.getElementById('log').textContent += message + '\n';
            console.log(message);
        };

        async function testPermissions() {
            try {
                // 1. Verificar usuario autenticado
                const user = auth.currentUser;
                if (!user) {
                    log('❌ No hay usuario autenticado');
                    document.getElementById('status').textContent = 'Por favor, inicia sesión primero';
                    return;
                }
                
                log(`✅ Usuario autenticado: ${user.email} (${user.uid})`);
                
                // 2. Verificar si es maestro
                const maestroDoc = await getDoc(doc(db, 'maestros', user.uid));
                if (!maestroDoc.exists()) {
                    log('❌ El usuario NO está en la colección maestros');
                    log('Creando documento en maestros...');
                    
                    await setDoc(doc(db, 'maestros', user.uid), {
                        activo: true,
                        nombre: user.displayName || 'Maestro ECOCE',
                        email: user.email,
                        fecha_creacion: serverTimestamp(),
                        permisos: {
                            aprobar_solicitudes: true,
                            eliminar_usuarios: true,
                            gestionar_sistema: true,
                        }
                    });
                    
                    log('✅ Usuario agregado a maestros');
                } else {
                    log('✅ Usuario encontrado en colección maestros');
                    log('Datos: ' + JSON.stringify(maestroDoc.data(), null, 2));
                }
                
                // 3. Probar crear en users_pending_deletion
                const testUserId = 'TEST_USER_123';
                log('\nProbando crear documento en users_pending_deletion...');
                
                try {
                    await setDoc(doc(db, 'users_pending_deletion', testUserId), {
                        userId: testUserId,
                        requestedBy: user.uid,
                        requestedAt: serverTimestamp(),
                        status: 'test',
                        reason: 'Prueba de permisos'
                    });
                    log('✅ Documento creado exitosamente');
                    
                    // Eliminar documento de prueba
                    await deleteDoc(doc(db, 'users_pending_deletion', testUserId));
                    log('✅ Documento de prueba eliminado');
                    
                } catch (error) {
                    log('❌ Error al crear/eliminar: ' + error.message);
                }
                
                // 4. Probar eliminar un perfil de prueba
                log('\nProbando eliminar perfil de ecoce_profiles...');
                const testProfileId = 'TEST_PROFILE_123';
                
                try {
                    // Primero crear un perfil de prueba
                    await setDoc(doc(db, 'ecoce_profiles', testProfileId), {
                        test: true,
                        createdAt: serverTimestamp()
                    });
                    log('✅ Perfil de prueba creado');
                    
                    // Intentar eliminarlo
                    await deleteDoc(doc(db, 'ecoce_profiles', testProfileId));
                    log('✅ Perfil de prueba eliminado exitosamente');
                    
                } catch (error) {
                    log('❌ Error con perfil: ' + error.message);
                }
                
                document.getElementById('status').textContent = '✅ Pruebas completadas';
                
            } catch (error) {
                log('❌ Error general: ' + error.message);
                document.getElementById('status').textContent = '❌ Error en las pruebas';
            }
        }

        // Esperar a que el usuario esté autenticado
        auth.onAuthStateChanged((user) => {
            if (user) {
                testPermissions();
            } else {
                document.getElementById('status').textContent = 'Usuario no autenticado';
            }
        });
    </script>
    
    <p>Para usar esta prueba:</p>
    <ol>
        <li>Inicia sesión como maestro en la aplicación</li>
        <li>Abre esta página en el navegador</li>
        <li>Revisa los resultados en la consola</li>
    </ol>
</body>
</html>